#!/bin/bash
TEAM_ID=158

# Get the most recent gamePk for this team (try last 7 days)
GAME_ID=$(curl -s "https://statsapi.mlb.com/api/v1/schedule?sportId=1&teamId=$TEAM_ID&startDate=$(date -d '7 days ago' +%Y-%m-%d)&endDate=$(date +%Y-%m-%d)" |
    jq -r '.dates[-1].games[0].gamePk // empty')

echo "Game ID: $GAME_ID" >&2

# Check if we found a game
if [ -z "$GAME_ID" ] || [ "$GAME_ID" = "null" ]; then
    echo "No recent games found for team $TEAM_ID" >&2
    exit 1
fi

# Get team names from boxscore API
TEAM_NAMES=$(curl -s "https://statsapi.mlb.com/api/v1/game/$GAME_ID/boxscore" | jq -r '
  .teams.away.team.name + "|" + .teams.home.team.name
')
AWAY_NAME=$(echo "$TEAM_NAMES" | cut -d'|' -f1)
HOME_NAME=$(echo "$TEAM_NAMES" | cut -d'|' -f2)

# Get the linescore JSON for that game
curl -s "https://statsapi.mlb.com/api/v1/game/$GAME_ID/linescore" | jq -r --arg away_name "$AWAY_NAME" --arg home_name "$HOME_NAME" '
  $away_name as $away_name |
  $home_name as $home_name |
  (.innings | length) as $total_innings |
  
  # Header row: inning numbers + R/H/E
  ([.innings[].num | tostring] + ["R","H","E"]) as $header |
  
  # Away row: replace null with "-"
  ([.innings[] | (.away.runs // "-" | tostring)] +
   [(.teams.away.runs|tostring),
    (.teams.away.hits|tostring),
    (.teams.away.errors|tostring)]) as $away |
  
  # Home row: replace null with "-", show "x" for bottom of final inning if game is complete
  ([.innings[] | 
    if (.home.runs == null and .num == $total_innings and (.currentInning // $total_innings) >= $total_innings and (.inningState // "Final") != "Middle") 
    then "x" 
    else (.home.runs // "-" | tostring) 
    end] +
   [(.teams.home.runs|tostring),
    (.teams.home.hits|tostring),
    (.teams.home.errors|tostring)]) as $home |
  
  # Output team names and grid separately
  $away_name,
  ($header | join("  ")),
  ($away | join("  ")),
  "",
  $home_name,
  ($home | join("  "))
'
